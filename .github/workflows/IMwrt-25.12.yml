name: IMwrt-25.12固件构建

on:
  repository_dispatch:
    types: [build_firmware]
  workflow_dispatch:
    inputs:
      device_model:
        description: '选择目标设备型号 (代码)'
        type: choice
        required: true
        options:
          - cmcc_rax3000m
          - cmcc_rax3000m-emmc
          - cudy_ap3000-v1
          - cudy_ap3000outdoor-v1
          - cudy_m3000-v1
          - cudy_re3000-v1
          - cudy_tr3000-v1
          - cudy_tr3000-v1-256mb
          - cudy_wr3000-v1
          - cudy_wr3000s-v1
          - glinet_gl-mt2500
          - glinet_gl-mt3000
          - glinet_gl-x3000
          - glinet_gl-xe3000
          - h3c_magic-nx30-pro
          - huasifei_wh3000-pro
          - huasifei_wh3000-emmc
          - jcg_q30-pro
          - livinet_zr-3020
          - routerich_ax3000
          - routerich_ax3000-v1
          - xiaomi_mi-router-ax3000t
          - xiaomi_mi-router-wr30u-stock
          - xiaomi_redmi-router-ax6000-stock
          - zyxel_ex5601-t0-stock
          - zyxel_nwa50ax-pro
      enable_5g_25db:
        description: '启用5G 25dB修改'
        type: boolean
        required: true
        default: true
      repo_url:
        description: '源代码仓库URL'
        default: 'https://github.com/chasey-dev/immortalwrt-mt798x-rebase'
      repo_branch:
        description: '源代码仓库分支'
        default: '25.12-dev'
  schedule:
    - cron: '0 7 * * 5' # 每周五07:00 UTC（北京时间15:00）

permissions:
  contents: write
  actions: write

env:
  REPO_URL: ${{ github.event.inputs.repo_url || 'https://github.com/chasey-dev/immortalwrt-mt798x-rebase' }}
  REPO_BRANCH: ${{ github.event.inputs.repo_branch || '25.12-dev' }}
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: IMwrt-25.12.config
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
  WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
  ENABLE_5G_25DB: ${{ github.event.inputs.enable_5g_25db || 'true' }}

jobs:
  check-source-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: 下载上次检查的 commit
        uses: actions/download-artifact@v4
        with:
          name: last-checked-sha
        continue-on-error: true

      - name: 检查源代码更新
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update -y && sudo apt-get install -y gh
          LATEST_SHA=$(gh api repos/chasey-dev/immortalwrt-mt798x-rebase/commits/$REPO_BRANCH --jq '.sha' 2>/dev/null || echo "")
          if [ -z "$LATEST_SHA" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          LAST_SHA=$(cat last_checked_sha.txt 2>/dev/null || echo "")
          if [ "$LATEST_SHA" != "$LAST_SHA" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "$LATEST_SHA" > last_checked_sha.txt
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: 上传本次 commit SHA
        uses: actions/upload-artifact@v4
        with:
          name: last-checked-sha
          path: last_checked_sha.txt
          if-no-files-found: ignore

  build:
    needs: check-source-updates
    if: github.event_name == 'workflow_dispatch' || needs.check-source-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device_model: ${{ fromJson(github.event_name == 'workflow_dispatch' && format('["{0}"]', github.event.inputs.device_model) || '["cmcc_rax3000m","cmcc_rax3000m-emmc","cudy_ap3000-v1","cudy_ap3000outdoor-v1","cudy_m3000-v1","cudy_re3000-v1","cudy_tr3000-v1","cudy_tr3000-v1-256mb","cudy_wr3000-v1","cudy_wr3000s-v1","glinet_gl-mt2500","glinet_gl-mt3000","glinet_gl-x3000","glinet_gl-xe3000","h3c_magic-nx30-pro","huasifei_wh3000-pro","huasifei_wh3000-emmc","jcg_q30-pro","livinet_zr-3020","routerich_ax3000","routerich_ax3000-v1","xiaomi_mi-router-ax3000t","xiaomi_mi-router-wr30u-stock","xiaomi_redmi-router-ax6000-stock","zyxel_ex5601-t0-stock","zyxel_nwa50ax-pro"]') }}
      max-parallel: 18

    steps:
      - name: 打印调试信息
        run: |
          echo "触发类型：${{ github.event_name }}"
          echo "设备型号：${{ matrix.device_model }}"
          echo "5G 25dB：${{ env.ENABLE_5G_25DB }}"

      - name: 设置设备代码
        run: echo "device_code=${{ matrix.device_model }}" >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: 安装编译依赖（Ubuntu 24.04兼容）
        run: |
          sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g; s/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
          sudo apt-get update -y
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools python3-ply python3-docutils python3-pyelftools \
            quilt rsync unzip zlib1g-dev file wget time xsltproc ccache ecj fastjar \
            mkisofs device-tree-compiler libelf-dev binutils-dev lib32gcc-s1 \
            libc6-dev-i386 subversion swig libglib2.0-dev libzstd-dev \
            python3-distutils-extra || true  # distutils-extra 作为备用
          python3 -m pip install --user setuptools  # 兼容旧 distutils 使用
          sudo timedatectl set-timezone "$TZ" || true
          sudo mkdir -p /workdir && sudo chown -R $USER /workdir
          echo "export PATH=/usr/lib/ccache:\$PATH" >> $GITHUB_ENV
          echo "export CCACHE_DIR=\$HOME/.ccache" >> $GITHUB_ENV
          ccache -M 6G

      - uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            /workdir/openwrt
            /workdir/openwrt/feeds
          key: ${{ runner.os }}-build-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles('openwrt/feeds.conf.default', 'openwrt/.config') }}
          restore-keys: ${{ runner.os }}-build-

      - name: 克隆或更新源代码
        working-directory: /workdir
        run: |
          if [ -d openwrt ]; then
            cd openwrt
            git fetch origin
            git checkout $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fdx
          else
            git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
          fi
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: 准备 Feeds、配置和 DIY 脚本
        run: |
          cd $GITHUB_WORKSPACE
          [ -f "$FEEDS_CONF" ] && mv "$FEEDS_CONF" openwrt/feeds.conf.default || true
          [ -d files ] && mv files openwrt/files || true
          [ -f "$CONFIG_FILE" ] && mv "$CONFIG_FILE" openwrt/.config || true

          cd openwrt
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${{ env.device_code }}=y" >> .config

          chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH $GITHUB_WORKSPACE/$DIY_P2_SH 2>/dev/null || true
          $GITHUB_WORKSPACE/$DIY_P1_SH || true

          ./scripts/feeds update -a || { sleep 10; ./scripts/feeds update -a; } && ./scripts/feeds install -a

          $GITHUB_WORKSPACE/$DIY_P2_SH || true
          make defconfig
          make download -j$(nproc) || make download -j1 || true

      - name: 修改5G 25dB（如果启用）
        if: env.ENABLE_5G_25DB == 'true'
        working-directory: openwrt
        run: |
          # 路径根据 chasey-dev 仓库可能位置调整；实际编译失败时查看 build log 中的 eeprom 文件路径
          EEPROM_PATH=$(find package/kernel/mt_wifi -name "*MT7981*EEPROM*.bin" 2>/dev/null | head -1 || echo "")
          if [ -z "$EEPROM_PATH" ] || [ ! -f "$EEPROM_PATH" ]; then
            echo "未找到 MT7981 EEPROM 文件，跳过 25dB 修改"
            exit 0
          fi
          mkdir -p eeprom_backup
          cp -f "$EEPROM_PATH" eeprom_backup/$(basename "$EEPROM_PATH").bak
          OFFSET=1093  # 0x445 十进制
          EXPECTED=$(printf '\x2B%.0s' {1..20})
          CURRENT=$(dd if="$EEPROM_PATH" bs=1 skip=$OFFSET count=20 2>/dev/null)
          if [ "$CURRENT" != "$EXPECTED" ]; then
            printf '%s' "$EXPECTED" | dd of="$EEPROM_PATH" bs=1 seek=$OFFSET conv=notrunc
            echo "已将 5G EEPROM 偏移 0x445 修改为 25dB (0x2B x20)"
          else
            echo "EEPROM 已为 25dB，无需修改"
          fi

      - name: 编译固件
        timeout-minutes: 300
        working-directory: openwrt
        run: |
          make -j$(nproc) V=s || make -j4 V=s IGNORE_ERRORS=1 || make -j1 V=s IGNORE_ERRORS=1

      - name: 提取版本号
        id: version
        working-directory: openwrt
        run: |
          REV=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          echo "FIRMWARE_VERSION=25.12-$(date +%Y%m%d)-${REV}" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 整理固件文件
        if: env.UPLOAD_FIRMWARE == 'true'
        working-directory: openwrt/bin/targets/mediatek/filogic
        run: |
          rm -rf packages || true
          for file in *sysupgrade*.* *factory*.*; do
            if [[ -f "$file" && ! "$file" =~ -bl2|-ubi|-initramfs ]]; then
              ext="${file##*.}"
              type=$(echo "$file" | grep -oE "sysupgrade|factory")
              new_name="${{ env.device_code }}_${{ env.FIRMWARE_VERSION }}_${{ env.ENABLE_5G_25DB == 'true' && '25dB' || 'stock' }}_${type}.${ext}"
              mv "$file" "$new_name"
            fi
          done
          echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV

      - name: 生成 README
        if: env.UPLOAD_FIRMWARE == 'true'
        working-directory: ${{ env.FIRMWARE_DIR }}
        run: |
          cat << EOF > README.md
          # ImmortalWrt 25.12 (MT798x) 固件
          - 设备: ${{ env.device_code }}
          - 版本: ${{ env.FIRMWARE_VERSION }}
          - 构建时间: $(date '+%Y-%m-%d %H:%M %Z')
          - 5G 功率: ${{ env.ENABLE_5G_25DB == 'true' && '已启用 25dB' || '默认' }}
          - 来源: chasey-dev/immortalwrt-mt798x-rebase @ 25.12-dev
          默认 IP: 192.168.1.1 或 192.168.2.1   密码: 空 或 password
          注意: 第三方固件，使用风险自负。
          EOF

      - name: 发布到 GitHub Releases
        if: env.UPLOAD_RELEASE == 'true'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ImmortalWrt-25.12-${{ env.device_code }}-${{ env.FIRMWARE_VERSION }}
          name: ImmortalWrt 25.12 - ${{ env.device_code }} (${{ env.FIRMWARE_VERSION }})
          body_path: ${{ env.FIRMWARE_DIR }}/README.md
          files: |
            ${{ env.FIRMWARE_DIR }}/*sysupgrade*.*
            ${{ env.FIRMWARE_DIR }}/*factory*.*
            ${{ env.FIRMWARE_DIR }}/README.md
          fail_on_unmatched_files: false

      - name: 上传到 WebDAV（如果配置）
        if: env.WEBDAV_URL != '' && env.WEBDAV_USERNAME != '' && env.WEBDAV_PASSWORD != ''
        working-directory: ${{ env.FIRMWARE_DIR }}
        run: |
          FILES=$(find . -type f \( -name "*sysupgrade*.*" -o -name "*factory*.*" -o -name "README.md" \))
          for file in $FILES; do
            base=$(basename "$file")
            curl -u "${{ env.WEBDAV_USERNAME }}:${{ env.WEBDAV_PASSWORD }}" -T "$file" "${{ env.WEBDAV_URL }}/${{ env.device_code }}_${base}" || echo "上传失败: $base"
          done

      - name: 清理旧 Releases（保留最近 3 个同设备）
        if: env.UPLOAD_RELEASE == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 30 --json tagName | jq -r '.[] | select(.tagName | startswith("ImmortalWrt-25.12-${{ env.device_code }}")) | .tagName' | sort -r | tail -n +4 | xargs -I {} gh release delete {} --yes || true