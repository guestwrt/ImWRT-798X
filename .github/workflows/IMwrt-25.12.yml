name: IMwrt-25.12固件构建

on:
  repository_dispatch:
    types: [build_firmware]
  workflow_dispatch:
    inputs:
      device_model:
        description: '选择目标设备型号 (代码)'
        type: choice
        required: true
        options:
          - cmcc_rax3000m
          - cmcc_rax3000m-emmc
          - cudy_ap3000-v1
          - cudy_ap3000outdoor-v1
          - cudy_m3000-v1
          - cudy_re3000-v1
          - cudy_tr3000-v1
          - cudy_tr3000-v1-256mb
          - cudy_wr3000-v1
          - cudy_wr3000s-v1
          - glinet_gl-mt2500
          - glinet_gl-mt3000
          - glinet_gl-x3000
          - glinet_gl-xe3000
          - h3c_magic-nx30-pro
          - huasifei_wh3000-pro
          - huasifei_wh3000-emmc
          - jcg_q30-pro
          - livinet_zr-3020
          - routerich_ax3000
          - routerich_ax3000-v1
          - xiaomi_mi-router-ax3000t
          - xiaomi_mi-router-wr30u-stock
          - xiaomi_redmi-router-ax6000-stock
          - zyxel_ex5601-t0-stock
          - zyxel_nwa50ax-pro
      enable_5g_25db:
        description: '启用5G 25dB修改'
        type: boolean
        required: true
        default: true
      repo_url:
        description: '源代码仓库URL'
        default: 'https://github.com/chasey-dev/immortalwrt-mt798x-rebase'
      repo_branch:
        description: '源代码仓库分支'
        default: '25.12-dev'
  schedule:
    - cron: '0 7 * * 5' # 每周五 07:00 UTC ≈ 北京时间 15:00

permissions:
  contents: write
  actions: write

env:
  REPO_URL: ${{ github.event.inputs.repo_url || 'https://github.com/chasey-dev/immortalwrt-mt798x-rebase' }}
  REPO_BRANCH: ${{ github.event.inputs.repo_branch || '25.12-dev' }}
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: IMwrt-25.12.config
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
  WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
  ENABLE_5G_25DB: ${{ github.event.inputs.enable_5g_25db || 'true' }}

jobs:
  check-source-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: 下载上次检查的 commit SHA
        uses: actions/download-artifact@v4
        with:
          name: last-checked-sha
        continue-on-error: true

      - name: 检查源代码更新
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y gh
          LATEST_SHA=$(gh api repos/chasey-dev/immortalwrt-mt798x-rebase/commits/$REPO_BRANCH --jq '.sha' 2>/dev/null || echo "")
          if [ -z "$LATEST_SHA" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          LAST_SHA=$(cat last_checked_sha.txt 2>/dev/null || echo "")
          if [ "$LATEST_SHA" != "$LAST_SHA" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "$LATEST_SHA" > last_checked_sha.txt
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: 上传本次 SHA
        uses: actions/upload-artifact@v4
        with:
          name: last-checked-sha
          path: last_checked_sha.txt
          if-no-files-found: ignore

  build:
    needs: check-source-updates
    if: github.event_name == 'workflow_dispatch' || needs.check-source-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device_model: >-
          ${{ github.event_name == 'workflow_dispatch'
              && fromJson(format('["{0}"]', github.event.inputs.device_model))
              || fromJson('["cmcc_rax3000m","cmcc_rax3000m-emmc","cudy_ap3000-v1","cudy_ap3000outdoor-v1","cudy_m3000-v1","cudy_re3000-v1","cudy_tr3000-v1","cudy_tr3000-v1-256mb","cudy_wr3000-v1","cudy_wr3000s-v1","glinet_gl-mt2500","glinet_gl-mt3000","glinet_gl-x3000","glinet_gl-xe3000","h3c_magic-nx30-pro","huasifei_wh3000-pro","huasifei_wh3000-emmc","jcg_q30-pro","livinet_zr-3020","routerich_ax3000","routerich_ax3000-v1","xiaomi_mi-router-ax3000t","xiaomi_mi-router-wr30u-stock","xiaomi_redmi-router-ax6000-stock","zyxel_ex5601-t0-stock","zyxel_nwa50ax-pro"]')
          }}
      max-parallel: 18

    steps:
      - name: 打印信息
        run: |
          echo "触发: ${{ github.event_name }}"
          echo "设备: ${{ matrix.device_model }}"
          echo "5G 25dB: ${{ env.ENABLE_5G_25DB }}"

      - name: 设置 device_code
        run: echo "device_code=${{ matrix.device_model }}" >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: 安装编译依赖
        run: |
          sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g; s/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-distutils quilt rsync unzip zlib1g-dev file wget \
            time xsltproc ccache ecj fastjar mkisofs python3 python3-ply \
            python3-docutils python3-pyelftools device-tree-compiler \
            libelf-dev binutils-dev lib32gcc-s1 libc6-dev-i386 subversion \
            swig libglib2.0-dev
          sudo timedatectl set-timezone Asia/Shanghai || true
          mkdir -p /workdir && sudo chown $USER /workdir
          echo "export PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          echo "export CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache -M 6G

      - uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            /workdir/openwrt
            /workdir/openwrt/feeds
          key: ${{ runner.os }}-build-${{ hashFiles('openwrt/.config') }}-${{ env.REPO_BRANCH }}
          restore-keys: ${{ runner.os }}-build-

      - name: 克隆/更新源代码
        working-directory: /workdir
        run: |
          if [ -d openwrt ]; then
            cd openwrt
            git fetch --all
            git checkout $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fdx
          else
            git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt
          fi
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: 准备 feeds / config / diy
        run: |
          cd $GITHUB_WORKSPACE
          [ -f "$FEEDS_CONF" ] && mv "$FEEDS_CONF" openwrt/feeds.conf.default
          [ -d files ] && mv files openwrt/files || true
          [ -f "$CONFIG_FILE" ] && mv "$CONFIG_FILE" openwrt/.config || true

          cd openwrt
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${{ env.device_code }}=y" >> .config

          chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH $GITHUB_WORKSPACE/$DIY_P2_SH 2>/dev/null || true
          $GITHUB_WORKSPACE/$DIY_P1_SH || true

          ./scripts/feeds update -a && ./scripts/feeds install -a

          $GITHUB_WORKSPACE/$DIY_P2_SH || true
          make defconfig
          make download -j8 || make download -j1 || true

      - name: 应用 5G 25dB 修改（可选）
        if: env.ENABLE_5G_25DB == 'true'
        working-directory: openwrt
        run: |
          EEPROM="package/kernel/mt_wifi/files/MT7981_iPAiLNA_EEPROM.bin"  # 路径可能需根据实际调整
          [ ! -f "$EEPROM" ] && { echo "未找到 EEPROM 文件，跳过"; exit 0; }
          mkdir -p eeprom_backup
          cp -f "$EEPROM" eeprom_backup/
          OFFSET=1093  # 0x445 = 1093 十进制
          EXPECTED=$(printf '\x2B%.0s' {1..20})
          CURRENT=$(dd if="$EEPROM" bs=1 skip=$OFFSET count=20 2>/dev/null | xxd -p)
          if [ "$CURRENT" != "$(echo -n "$EXPECTED" | xxd -p)" ]; then
            printf '%s' "$EXPECTED" | dd of="$EEPROM" bs=1 seek=$OFFSET conv=notrunc
            echo "5G 已修改为 ~25dB"
          else
            echo "已经是 25dB，无需改"
          fi

      - name: 开始编译
        timeout-minutes: 300
        working-directory: openwrt
        run: |
          make -j$(nproc) V=s || make -j4 V=s || make -j1 V=s IGNORE_ERRORS=1

      - name: 提取版本信息
        id: version
        working-directory: openwrt
        run: |
          REV=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          DATE=$(git log -1 --format=%cd --date=short 2>/dev/null | tr -d '-' || echo "unknown")
          echo "FIRMWARE_VERSION=25.12-${DATE:2:4}-${REV}" >> $GITHUB_ENV

      - name: 整理固件文件
        working-directory: openwrt/bin/targets/mediatek/filogic
        run: |
          for f in *sysupgrade*.* *factory*.*; do
            [[ -f "$f" && ! "$f" =~ bl2|ubi|initramfs ]] || continue
            ext=${f##*.}
            typ=$(echo "$f" | grep -oE "sysupgrade|factory")
            new="${{ env.device_code }}_${{ env.FIRMWARE_VERSION }}_${{ env.ENABLE_5G_25DB == 'true' && '25dB' || 'default' }}_${typ}.${ext}"
            mv "$f" "$new"
          done
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      - name: 生成 README
        working-directory: ${{ env.FIRMWARE_PATH }}
        run: |
          cat << EOF > README.md
          ImmortalWrt 25.12 (MT798x) - ${{ env.device_code }}
          版本: ${{ env.FIRMWARE_VERSION }}
          构建: $(date '+%Y-%m-%d %H:%M')
          5G功率: ${{ env.ENABLE_5G_25DB == 'true' && '25dB 已启用' || '默认' }}
          来源: chasey-dev/immortalwrt-mt798x-rebase @ 25.12-dev
          默认IP: 192.168.2.1   密码: 空 或 password
          EOF
