name: ImmortalWrt-25.10 (Speed Optimized)

on:
  workflow_dispatch:
    inputs:
      device_model:
        description: 'é€‰æ‹©è®¾å¤‡å‹å·'
        type: choice
        required: true
        options:
          - cmcc_rax3000m
          - xiaomi_mi-router-ax3000t
          - glinet_gl-mt3000
          - xiaomi_redmi-router-ax6000-stock
      enable_5g_25db:
        description: 'å¯ç”¨5G 25dBä¿®æ”¹'
        type: boolean
        default: true

env:
  REPO_URL: https://github.com/chasey-dev/immortalwrt-mt798x-rebase
  REPO_BRANCH: 25.12-dev
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: mt7981-ax3000.config
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part3.sh
  TZ: Asia/Shanghai
  UPLOAD_FIRMWARE: 'true'
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USER: ${{ secrets.WEBDAV_USERNAME }}
  WEBDAV_PASS: ${{ secrets.WEBDAV_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: åŸºç¡€ç¯å¢ƒæ£€æŸ¥
        uses: actions/checkout@v4

      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´ & å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          # å…ˆåˆ é™¤ä¸å¿…è¦çš„ç›®å½•ï¼ˆä¿æŒåŸæ ·ï¼Œä½†ä¸åˆ  sources.list.dï¼Œå› ä¸º ubuntu-24.04 ç”¨çš„æ˜¯ ubuntu.sourcesï¼‰
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup /opt/hostedtoolcache/CodeQL

          # å…³é”®ï¼šå…ˆ updateï¼
          sudo apt-get update -y -qq

          # å®‰è£…æ‰€æœ‰éœ€è¦çš„åŒ…ï¼ˆ-y è‡ªåŠ¨ yesï¼Œ-qq å®‰é™æ¨¡å¼ï¼‰
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            clang \
            flex bison \
            g++ gawk \
            gcc-multilib g++-multilib \
            gettext \
            git \
            libncurses5-dev libssl-dev \
            python3-setuptools \
            rsync swig unzip zlib1g-dev \
            file wget curl ccache

          # æ¸…ç† apt ç¼“å­˜ï¼Œé‡Šæ”¾æ›´å¤šç©ºé—´
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir && sudo chown $USER:$USER /workdir

      - name: å…‹éš†æºç  (å¿…é¡»åœ¨æ¢å¤ç¼“å­˜å‰æ‰§è¡Œ)
        working-directory: /workdir
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: ç¼“å­˜åŠ é€Ÿ (åˆ†ç¦»ç¼“å­˜ç­–ç•¥)
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            /workdir/openwrt/dl
            /workdir/openwrt/staging_dir/host*
            /workdir/openwrt/staging_dir/toolchain*
          key: ${{ runner.os }}-openwrt-${{ github.event.inputs.device_model }}-${{ hashFiles('openwrt/include/**') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.event.inputs.device_model }}-

      - name: æ›´æ–° Feeds & æ‰§è¡Œ DIY è„šæœ¬
        run: |
          cd openwrt
          [ -f "$GITHUB_WORKSPACE/$FEEDS_CONF" ] && mv "$GITHUB_WORKSPACE/$FEEDS_CONF" ./feeds.conf.default
          chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH && $GITHUB_WORKSPACE/$DIY_P1_SH
          ./scripts/feeds update -a && ./scripts/feeds install -a
          chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH && $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: è‡ªåŠ¨æ³¨å…¥ 25dB EEPROM ä¿®æ”¹ (2.4G & 5G ç»Ÿä¸€ 25dB)
        if: github.event.inputs.enable_5g_25db == 'true'
        run: |
          cd openwrt
          # å®šä¹‰ç›®æ ‡æ–‡ä»¶å
          TARGET_NAME="MT7981_iPAiLNA_EEPROM.bin"
          
          if [[ "${{ github.event.inputs.device_model }}" =~ (ax3000t|rax3000m|mt3000) ]]; then
            echo "ğŸ” æ­£åœ¨æºç ç›®å½•ä¸­æœç´¢ $TARGET_NAME..."
            
            # ä½¿ç”¨ find å¯»æ‰¾æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶è·¯å¾„
            TARGET_FILES=$(find . -name "$TARGET_NAME")
            
            if [ -z "$TARGET_FILES" ]; then
              echo "âŒ é”™è¯¯ï¼šåœ¨æ•´ä¸ª openwrt ç›®å½•ä¸‹éƒ½æœªæ‰¾åˆ° $TARGET_NAME"
              echo "ç›®å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ç»“æ„å‚è€ƒï¼ˆå‰2çº§ï¼‰ï¼š"
              ls -R package/mtk 2>/dev/null | head -n 20
              exit 1
            fi
            
            for FILE_PATH in $TARGET_FILES; do
              echo "Found: $FILE_PATH"
              # æ‰§è¡Œæ³¨å…¥ï¼šä» 0x441 å¼€å§‹è¦†ç›– 20 ä¸ªå­—èŠ‚ä¸º 0x2F (25dB) 
              printf '\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F\x2F' | \
              dd of="$FILE_PATH" bs=1 seek=$((0x441)) conv=notrunc
              
              echo "âœ… å·²æˆåŠŸä¿®æ”¹: $FILE_PATH"
              # éªŒè¯ä¿®æ”¹ç»“æœ [cite: 6]
              hexdump -v -C -s 0x441 -n 16 "$FILE_PATH"
            done
          fi

      - name: ç”Ÿæˆ .config & å¼ºéŸ§ä¸‹è½½è½¯ä»¶åŒ…
        run: |
          cd openwrt
          [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ] && cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
          
          # æ¸…ç†æ‰€æœ‰æ—§ DEVICE é€‰æ‹©ï¼ˆå…³é”®ï¼é˜²æ­¢å¤šè®¾å¤‡å†²çªï¼‰
          sed -i '/CONFIG_TARGET_mediatek_filogic_DEVICE_/d' .config || true
          
          # å¯ç”¨å½“å‰é€‰æ‹©çš„è®¾å¤‡
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${{ github.event.inputs.device_model }}=y" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          
          make defconfig
          make download -j8 || make download -j1 V=s

      - name: ç¼–è¯‘å›ºä»¶ (å¤šæ ¸å…¨å¼€)
        run: |
          cd openwrt
          export CCACHE_DIR=$HOME/.ccache
          ccache -M 3G
          ccache -z
          
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s
          ccache -s

      - name: æ”¶é›†ä¸æ•´ç†å›ºä»¶ (åªä¿ç•™ sysupgrade)
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages 2>/dev/null || true
          
          # æ—¶é—´æ ¼å¼ï¼ˆé€‚é…ä½ çš„ Release bodyï¼‰
          DATE_DISPLAY=$(date +'%Y%m%d %H:%M')
          DATE_FILE=$(date +'%Y%m%d_%H%M')
          DB_SUFFIX="stock"
          [ "${{ github.event.inputs.enable_5g_25db }}" = "true" ] && DB_SUFFIX="25dB-on"
          
          echo "DATE=$DATE_DISPLAY" >> $GITHUB_ENV
          echo "DB_SUFFIX=$DB_SUFFIX" >> $GITHUB_ENV
          echo "FIRMWARE_VERSION=$(date +%Y%m%d)" >> $GITHUB_ENV
          echo "device_code=${{ github.event.inputs.device_model }}" >> $GITHUB_ENV
          
          # ==================== åªä¿ç•™ sysupgrade ====================
          for file in *; do
            [ -f "$file" ] && ! echo "$file" | grep -qE '-(bl2|recovery|sha256sums)' && [[ $file == *sysupgrade* ]] && {
              EXT="${file##*.}"
              NEW_NAME="${{ github.event.inputs.device_model }}_${DB_SUFFIX}_${DATE_FILE}_sysupgrade.${EXT}"
              mv "$file" "$NEW_NAME"
              echo "âœ… å›ºä»¶å°±ç»ª: $NEW_NAME"
            }
          done
          
          # åˆ é™¤æ‰€æœ‰é sysupgrade æ–‡ä»¶ï¼ˆå½»åº•åªä¿ç•™ sysupgradeï¼‰
          rm -f *factory* *recovery* *-bl2* *sha256sums* 2>/dev/null || true
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: åˆ é™¤æ—§ Release Assetsï¼ˆçœŸæ­£å®ç°è¦†ç›–ï¼‰
        if: steps.organize.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = `Latest-Build-${{ github.event.inputs.device_model }}`;
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
              for (const asset of release.data.assets) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
              }
              console.log(`âœ… å·²åˆ é™¤ ${release.data.assets.length} ä¸ªæ—§å›ºä»¶`);
            } catch (e) {
              console.log("ç¬¬ä¸€æ¬¡å‘å¸ƒæˆ–æ— æ—§æ–‡ä»¶ï¼Œè·³è¿‡åˆ é™¤");
            }

      - name: ä¸Šä¼ è‡³ WebDAV
        if: steps.organize.outputs.status == 'success' && env.WEBDAV_URL != ''
        run: |
          cd ${{ env.FIRMWARE_PATH }}
          for file in *; do
            [ -f "$file" ] && {
              curl -u "${{ env.WEBDAV_USER }}:${{ env.WEBDAV_PASS }}" -X DELETE "${{ env.WEBDAV_URL }}/$file" || true
              curl -k --retry 3 --retry-delay 5 -u "${{ env.WEBDAV_USER }}:${{ env.WEBDAV_PASS }}" -T "$file" "${{ env.WEBDAV_URL }}/$file"
            }
          done

      - name: å‘å¸ƒè‡³ GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.organize.outputs.status == 'success'
        with:
          tag_name: Latest-Build-${{ github.event.inputs.device_model }}
          files: ${{ env.FIRMWARE_PATH }}/*
          overwrite_files: true
          body: |
            ## ImmortalWrt è‡ªåŠ¨ç¼–è¯‘
            - **è®¾å¤‡å‹å·**: ${{ github.event.inputs.device_model }}
            - **5G 25dB**: ${{ github.event.inputs.enable_5g_25db }} (${{ env.DB_SUFFIX }})
            - **ç¼–è¯‘æ—¶é—´**: ${{ env.DATE }}
            - **åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
