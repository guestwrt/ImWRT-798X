name: ImmortalWrt-25.10

on:
  workflow_dispatch:
    inputs:
      device_model:
        description: '选择设备型号'
        type: choice
        required: true
        options:
          - xiaomi_mi-router-ax3000t
          - cmcc_rax3000m
          - glinet_gl-mt3000
          - xiaomi_redmi-router-ax6000-stock
      enable_5g_25db:
        description: '启用5G 25dB修改'
        type: boolean
        default: true

env:
  REPO_URL: https://github.com/chasey-dev/immortalwrt-mt798x-rebase
  REPO_BRANCH: 25.12-dev
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: 24.10-6.6.config
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part2.sh
  TZ: Asia/Shanghai
  # WebDAV 配置（需在仓库 Settings -> Secrets 中添加）
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USER: ${{ secrets.WEBDAV_USERNAME }}
  WEBDAV_PASS: ${{ secrets.WEBDAV_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 基础环境检查
        uses: actions/checkout@v4

      - name: 释放磁盘空间 & 安装工具链
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup
          sudo apt-get update
          # 核心修正：添加了 ccache
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget curl ccache
          sudo apt-get clean
          sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir

      - name: 缓存加速 (ccache & DL)
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            /workdir/openwrt/dl
          key: ${{ runner.os }}-build-${{ github.event.inputs.device_model }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: 克隆源码
        working-directory: /workdir
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: 更新 Feeds & DIY 脚本
        run: |
          cd openwrt
          [ -e "$GITHUB_WORKSPACE/$FEEDS_CONF" ] && mv "$GITHUB_WORKSPACE/$FEEDS_CONF" ./feeds.conf.default
          chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH && $GITHUB_WORKSPACE/$DIY_P1_SH
          ./scripts/feeds update -a && ./scripts/feeds install -a
          chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH && $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: 生成 .config & 下载软件包
        run: |
          [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" openwrt/.config
          cd openwrt
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${{ github.event.inputs.device_model }}=y" >> .config
          make defconfig
          make download -j8

      - name: 修改 5G 功率 (25dB)
        if: github.event.inputs.enable_5g_25db == 'true'
        run: |
          FILE="openwrt/package/mtk/drivers/mt_wifi/files/mt7981-default-eeprom/MT7981_iPAiLNA_EEPROM.bin"
          [ -f "$FILE" ] && printf '\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B' | dd of="$FILE" bs=1 seek=$((0x445)) conv=notrunc

      - name: 编译固件
        run: |
          cd openwrt
          # 设置 ccache 路径
          export PATH=/usr/lib/ccache:$PATH
          export CCACHE_DIR=$HOME/.ccache
          
          # 检查 ccache 是否安装成功并设置大小
          if command -v ccache > /dev/null; then
            ccache -M 5G
          else
            echo "ccache 未安装，将跳过缓存设置"
          fi

          # 执行编译
          make -j$(nproc) || make -j1 V=s

      - name: 整理文件 (固定名称)
        id: organize
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages/
          # 强制改名为固定格式：型号-版本-类型.bin
          for file in *sysupgrade.bin; do
            mv "$file" "${{ github.event.inputs.device_model }}-sysupgrade.bin"
          done
          for file in *factory.bin; do
            mv "$file" "${{ github.event.inputs.device_model }}-factory.bin"
          done
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 上传至 WebDAV
        if: steps.organize.outputs.status == 'success' && env.WEBDAV_URL != ''
        run: |
          cd ${{ env.FIRMWARE_PATH }}
          for file in *.bin; do
            echo "正在同步 $file 到 WebDAV..."
            # 使用 -X DELETE 先尝试删除旧文件，防止某些 WebDAV 服务禁止直接覆盖
            curl -u "${{ env.WEBDAV_USER }}:${{ env.WEBDAV_PASS }}" -X DELETE "${{ env.WEBDAV_URL }}/$file" || true
            # 正式上传
            curl -k --retry 3 --retry-delay 5 -u "${{ env.WEBDAV_USER }}:${{ env.WEBDAV_PASS }}" \
              -T "$file" "${{ env.WEBDAV_URL }}/$file"
          done

      - name: 发布并覆盖 GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.organize.outputs.status == 'success'
        with:
          tag_name: Latest-Build-${{ github.event.inputs.device_model }}
          files: ${{ env.FIRMWARE_PATH }}/*.bin
          overwrite: true
          body: |
            ## 自动编译说明
            - **型号**: ${{ github.event.inputs.device_model }}
            - **状态**: 每次编译会自动覆盖此 Release 下的文件。
            - **WebDAV**: 已同步上传。
            - **编译时间**: ${{ env.DATE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
