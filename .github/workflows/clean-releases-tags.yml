name: 清理旧 ImmortalWrt-24.10 Releases 和 Tags

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: '确认执行清理操作（必须勾选）'
        type: boolean
        required: true
        default: false
      retain_count:
        description: '保留最新的 Release 数量（0=全删，推荐3~10）'
        type: string
        required: false
        default: '5'

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_cleanup == 'true'

    steps:
      - name: 安装工具
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq
          gh --version
          jq --version

      - name: 设置保留数量
        id: params
        run: |
          RETAIN="${{ github.event.inputs.retain_count }}"
          if ! [[ "$RETAIN" =~ ^[0-9]+$ ]] || [ "$RETAIN" -lt 0 ]; then
            echo "无效的保留数量 '$RETAIN'，强制使用 5"
            RETAIN=5
          fi
          echo "retain=$RETAIN" >> $GITHUB_OUTPUT
          echo "将保留最新的 $RETAIN 个 Release / Tag"

      - name: 清理旧 Releases（自动删除关联 Tag）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RETAIN=${{ steps.params.outputs.retain }}

          echo "获取所有 ImmortalWrt-24.10 Releases（按创建时间降序）..."
          RELEASES_JSON=$(gh release list --json tagName,name,createdAt --limit 1000 --jq '
            sort_by(.createdAt) | reverse |
            map(select(.name | test("ImmortalWrt-24.10"; "i")))
          ') || {
            echo "gh release list 失败，可能无权限或网络问题"
            exit 1
          }

          COUNT=$(echo "$RELEASES_JSON" | jq 'length' || echo 0)
          echo "找到 $COUNT 个匹配的 Releases"

          if [ "$COUNT" -eq 0 ]; then
            echo "没有匹配的 Release，跳过删除"
            exit 0
          fi

          echo "$RELEASES_JSON" | jq -r '.[].name'

          # 安全切片：如果 RETAIN >= COUNT，则 TO_DELETE 为空
          TO_DELETE=$(echo "$RELEASES_JSON" | jq -r --argjson r "$RETAIN" '
            if $r >= length then empty
            else .[$r:][] | .tagName
            end
          ' || echo "")

          if [ -z "$TO_DELETE" ]; then
            echo "无需删除（实际数量 ≤ $RETAIN）"
          else
            echo "待删除的 tag_names（及其 Release）："
            echo "$TO_DELETE" | tr ' ' '\n' || echo "$TO_DELETE"

            echo "$TO_DELETE" | while read -r tag; do
              [ -z "$tag" ] && continue
              echo "删除 Release + Tag: $tag"
              for try in {1..3}; do
                gh release delete "$tag" --cleanup-tag --yes && {
                  echo "成功删除 $tag"
                  break
                }
                echo "尝试 $try/3 失败，重试..."
                sleep $((try * 3))
              done || echo "删除 $tag 失败（可能已不存在或权限问题）"
            done
          fi

      - name: 清理孤立 Tags（不属于任何 Release 的 ImmortalWrt-24.10 tag）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "获取所有 ImmortalWrt-24.10 Tags..."
          TAGS_JSON=$(gh api --paginate repos/${{ github.repository }}/tags --jq '
            map(select(.name | test("immortalwrt-24.10"; "i")))
          ') || {
            echo "获取 Tags 失败"
            exit 1
          }

          TAG_COUNT=$(echo "$TAGS_JSON" | jq 'length' || echo 0)
          echo "找到 $TAG_COUNT 个匹配的 Tags"

          if [ "$TAG_COUNT" -eq 0 ]; then
            echo "没有匹配的 Tag，跳过"
            exit 0
          fi

          # 当前所有 Release 的 tag_name（已保留或全部）
          CURRENT_TAGS=$(gh release list --json tagName --jq '.[].tagName' | sort -u || echo "")

          echo "当前 Release 关联的 Tags："
          echo "$CURRENT_TAGS" || echo "无"

          # 找出孤立 tag
          TO_DELETE_TAGS=$(echo "$TAGS_JSON" | jq -r --argjson current "$(echo "$CURRENT_TAGS" | jq -R .)" '
            .[] | .name as $n |
            if ($current | index($n)) then empty else $n end
          ' || echo "")

          if [ -z "$TO_DELETE_TAGS" ]; then
            echo "没有孤立 Tag 需要删除"
          else
            echo "待删除的孤立 Tags："
            echo "$TO_DELETE_TAGS" | tr ' ' '\n'

            echo "$TO_DELETE_TAGS" | while read -r tag; do
              [ -z "$tag" ] && continue
              echo "删除 Tag: $tag"
              for try in {1..4}; do
                gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" && {
                  echo "成功删除 $tag"
                  break
                }
                echo "尝试 $try/4 失败，重试..."
                sleep $((try * 4))
              done || echo "删除 Tag $tag 失败（可能已不存在）"
            done
          fi

      - name: 显示最终状态（验证）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== 清理完成后状态 ==="
          echo "剩余 ImmortalWrt-24.10 Releases（前10个）："
          gh release list --json name,tagName,createdAt --limit 10 --jq '
            sort_by(.createdAt) | reverse |
            map(select(.name | test("ImmortalWrt-24.10"; "i")))
          ' || echo "无"

          echo -e "\n剩余 ImmortalWrt-24.10 Tags（前10个）："
          gh api repos/${{ github.repository }}/tags --jq '
            map(select(.name | test("immortalwrt-24.10"; "i"))) |
            sort_by(.commit.author.date) | reverse | .[:10] | .[].name
          ' || echo "无"
