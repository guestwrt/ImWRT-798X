name: 清理旧发布和标签 (ImmortalWrt-24.10)

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: '确认执行清理操作（必须勾选）'
        type: boolean
        required: true
        default: false
      retain_count:
        description: '保留最新的 Release 和 Tag 数量（0 = 全删，建议 3~10）'
        type: string
        required: false
        default: '3'

permissions:
  contents: write   # 必须有 write 权限才能删除 release 和 tag

jobs:
  clean-old-releases-and-tags:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_cleanup == 'true'

    steps:
      - name: 检出代码（其实这里不需要，但保持习惯）
        uses: actions/checkout@v4

      - name: 安装必要工具
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq
          gh --version
          jq --version

      - name: 解析并验证保留数量
        id: set-retain
        run: |
          RETAIN="${{ github.event.inputs.retain_count }}"
          if ! [[ "$RETAIN" =~ ^[0-9]+$ ]] || [ "$RETAIN" -lt 0 ]; then
            echo "输入的保留数量无效（$RETAIN），强制使用 3"
            RETAIN=3
          fi
          echo "retain=$RETAIN" >> $GITHUB_OUTPUT
          echo "将保留最新的 $RETAIN 个 Release / Tag"

      - name: 清理旧 Releases（并自动删除关联 Tag）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RETAIN=${{ steps.set-retain.outputs.retain }}

          echo "获取所有 ImmortalWrt-24.10 相关的 Releases（按创建时间降序）..."
          # 使用 gh release list + json 更可靠，也支持 --limit
          RELEASE_JSON=$(gh release list --json tagName,name,createdAt --jq '
            sort_by(.createdAt) | reverse |
            map(select(.name | test("ImmortalWrt-24.10"; "i")))
          ' --limit 500)  # 一般够用，如超多可再分页

          if [ "$(echo "$RELEASE_JSON" | jq length)" -eq 0 ]; then
            echo "没有找到符合条件的 Release，跳过"
            exit 0
          fi

          echo "找到的 Releases（最新在前）："
          echo "$RELEASE_JSON" | jq -r '.[].name'

          # 待删除的 Releases（从第 RETAIN+1 个开始）
          TO_DELETE=$(echo "$RELEASE_JSON" | jq -r '.[env.RETAIN | tonumber:] | .[].tagName')

          if [ -z "$TO_DELETE" ]; then
            echo "无需删除任何 Release（已 ≤ $RETAIN 个）"
          else
            echo "即将删除以下 Release（及其 Tag）："
            echo "$TO_DELETE" | tr ' ' '\n'

            echo "$TO_DELETE" | while read -r tag; do
              if [ -n "$tag" ]; then
                echo "删除 Release + Tag: $tag"
                for try in {1..3}; do
                  gh release delete "$tag" --cleanup-tag --yes && break
                  echo "第 $try 次失败，重试..."
                  sleep $((try*3))
                done || echo "!!! 删除 $tag 失败，请手动检查"
              fi
            done
          fi

      - name: 清理孤立 Tags（不关联任何 Release 的 ImmortalWrt-24.10 tag）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "获取所有 ImmortalWrt-24.10 相关的 Tags..."
          TAGS_JSON=$(gh api repos/${{ github.repository }}/tags --paginate --jq '
            sort_by(.commit.author.date) | reverse |
            map(select(.name | test("immortalwrt-24.10"; "i")))
          ')

          if [ "$(echo "$TAGS_JSON" | jq length)" -eq 0 ]; then
            echo "没有找到符合条件的 Tag，跳过"
            exit 0
          fi

          # 当前剩余的 Release tags（已保留的）
          CURRENT_RELEASE_TAGS=$(gh release list --json tagName --jq '.[].tagName' | sort | uniq)

          echo "当前存在的 Release 关联的 Tags："
          echo "$CURRENT_RELEASE_TAGS"

          # 找出需要删除的孤立 tag
          TO_DELETE_TAGS=""
          while read -r tag; do
            if ! echo "$CURRENT_RELEASE_TAGS" | grep -q "^$tag$"; then
              TO_DELETE_TAGS="$TO_DELETE_TAGS $tag"
            fi
          done < <(echo "$TAGS_JSON" | jq -r '.[].name')

          if [ -z "$TO_DELETE_TAGS" ]; then
            echo "没有孤立的 Tag 需要清理"
          else
            echo "即将删除以下孤立 Tags："
            echo "$TO_DELETE_TAGS" | tr ' ' '\n'

            for tag in $TO_DELETE_TAGS; do
              echo "删除 Tag: $tag"
              for try in {1..4}; do
                gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" && break
                echo "第 $try 次失败，重试..."
                sleep $((try*4))
              done || echo "!!! 删除 Tag $tag 失败"
            done
          fi

      - name: 输出最终状态（验证用）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== 清理后状态 ==="
          echo "剩余 Releases:"
          gh release list --json name,tagName,createdAt --jq '
            sort_by(.createdAt) | reverse |
            map(select(.name | test("ImmortalWrt-24.10"; "i"))) | .[:10]
          ' || echo "无"

          echo -e "\n剩余 Tags (前10个):"
          gh api repos/${{ github.repository }}/tags --jq '
            sort_by(.commit.author.date) | reverse |
            map(select(.name | test("immortalwrt-24.10"; "i"))) | .[:10] | .[].name
          ' || echo "无"
