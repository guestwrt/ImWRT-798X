name: 清理旧 ImmortalWrt-24.10 Releases 和 Tags

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: '确认执行清理操作（必须勾选）'
        type: boolean
        required: true
        default: false
      retain_count:
        description: '保留最新的 Release 数量（0=全删，推荐3~10）'
        type: string
        required: false
        default: '5'

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_cleanup == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 可选：如果后续需要 git log 或其他历史，可保留完整历史

      - name: 安装工具
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq
          gh --version
          jq --version

      - name: 设置保留数量
        id: params
        run: |
          RETAIN="${{ github.event.inputs.retain_count }}"
          if ! [[ "$RETAIN" =~ ^[0-9]+$ ]] || [ "$RETAIN" -lt 0 ]; then
            echo "无效的保留数量 '$RETAIN'，强制使用 5"
            RETAIN=5
          fi
          echo "retain=$RETAIN" >> $GITHUB_OUTPUT
          echo "将保留最新的 $RETAIN 个 Release"

      - name: 清理旧 Releases（自动删除关联 Tag）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RETAIN=${{ steps.params.outputs.retain }}

          echo "获取所有 ImmortalWrt-24.10 Releases（按创建时间降序）..."
          RELEASES_JSON=$(gh release list --json tagName,name,createdAt --limit 1000 --jq '
            sort_by(.createdAt) | reverse |
            map(select(.name | test("ImmortalWrt-24.10"; "i")))
          ') || {
            echo "gh release list 失败"
            exit 1
          }

          COUNT=$(echo "$RELEASES_JSON" | jq 'length' || echo 0)
          echo "找到 $COUNT 个匹配的 Releases"

          if [ "$COUNT" -eq 0 ]; then
            echo "没有匹配的 Release，跳过删除"
            exit 0
          fi

          echo "$RELEASES_JSON" | jq -r '.[].name'

          TO_DELETE=$(echo "$RELEASES_JSON" | jq -r --argjson r "$RETAIN" '
            if $r >= length then empty
            else .[$r:][] | .tagName
            end
          ' || echo "")

          if [ -z "$TO_DELETE" ]; then
            echo "无需删除（实际数量 ≤ $RETAIN）"
          else
            echo "即将删除以下 Release 的 tag_name："
            echo "$TO_DELETE" | sort || echo "$TO_DELETE"

            while IFS= read -r tag; do
              [ -z "$tag" ] && continue
              echo "删除 Release + Tag: $tag"
              for try in {1..3}; do
                if gh release delete "$tag" --cleanup-tag --yes; then
                  echo "成功删除 $tag"
                  break
                fi
                echo "尝试 $try/3 失败，重试..."
                sleep $((try * 3))
              done || echo "警告：删除 $tag 失败（可能已不存在或权限不足）"
            done <<< "$TO_DELETE"
          fi

      - name: 清理孤立 Tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "获取所有匹配的 Tags..."
          TAGS_JSON=$(gh api --paginate repos/${{ github.repository }}/tags --jq '
            map(select(.name | test("immortalwrt-24.10"; "i")))
          ') || exit 1

          TAG_COUNT=$(echo "$TAGS_JSON" | jq 'length' || echo 0)
          echo "找到 $TAG_COUNT 个匹配 Tags"

          if [ "$TAG_COUNT" -eq 0 ]; then
            echo "没有匹配 Tag，跳过"
            exit 0
          fi

          CURRENT_TAGS=$(gh release list --json tagName --jq '.[].tagName' | sort -u || echo "")

          TO_DELETE_TAGS=$(echo "$TAGS_JSON" | jq -r --argjson curr "$CURRENT_TAGS" '
            .[] | .name as $n |
            if ($curr | contains($n)) then empty else $n end
          ' || echo "")

          if [ -z "$TO_DELETE_TAGS" ]; then
            echo "没有孤立 Tag"
          else
            echo "即将删除孤立 Tags："
            echo "$TO_DELETE_TAGS" | sort

            while IFS= read -r tag; do
              [ -z "$tag" ] && continue
              echo "删除 Tag: $tag"
              for try in {1..4}; do
                if gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag"; then
                  echo "成功"
                  break
                fi
                echo "尝试 $try/4 失败，重试..."
                sleep $((try * 4))
              done || echo "删除 $tag 失败"
            done <<< "$TO_DELETE_TAGS"
          fi

      - name: 显示最终状态
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== 清理后状态 ==="
          echo "剩余 Releases（前10）："
          gh release list --limit 10 --json name,tagName,createdAt --jq '
            sort_by(.createdAt) | reverse |
            map(select(.name | test("ImmortalWrt-24.10"; "i")))
          ' || echo "无剩余 Release"

          echo -e "\n剩余 Tags（前10）："
          gh api repos/${{ github.repository }}/tags --jq '
            map(select(.name | test("immortalwrt-24.10"; "i"))) |
            sort_by(.commit.author.date) | reverse | .[:10] | .[].name // "无"
          '
